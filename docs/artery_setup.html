

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Artery Setup &mdash; Framework Manual 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=359c27e9"></script>
      <script src="_static/doctools.js?v=888ff710"></script>
      <script src="_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Run Simulation" href="run_simulation.html" />
    <link rel="prev" title="CARLA and SUMO Setup" href="carla_sumo_cosim.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Framework Manual
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="prerequisites.html">Prerequisites</a><ul>
<li class="toctree-l2"><a class="reference internal" href="prerequisites.html#carla-installation">CARLA Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="prerequisites.html#sumo-installation">SUMO Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="prerequisites.html#omnet-installation">OMNeT++ Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="prerequisites.html#zeromq-installation">ZeroMQ Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="prerequisites.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="carla_sumo_cosim.html">CARLA and SUMO Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="carla_sumo_cosim.html#carla-simulation-py">carla_simulation.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="carla_sumo_cosim.html#run-synchronization-py">run_synchronization.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="carla_sumo_cosim.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Artery Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#zeromq-integration">ZeroMQ Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#service-development">Service Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="#scenario-development">Scenario Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="run_simulation.html">Run Simulation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="run_simulation.html#launching-carla">Launching CARLA</a></li>
<li class="toctree-l2"><a class="reference internal" href="run_simulation.html#switching-carla-to-town05">Switching CARLA to Town05</a></li>
<li class="toctree-l2"><a class="reference internal" href="run_simulation.html#running-artery">Running Artery</a></li>
<li class="toctree-l2"><a class="reference internal" href="run_simulation.html#explanation">Explanation</a></li>
<li class="toctree-l2"><a class="reference internal" href="run_simulation.html#video-demonstration">Video Demonstration</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Framework Manual</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Artery Setup</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/artery_setup.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="artery-setup">
<h1>Artery Setup<a class="headerlink" href="#artery-setup" title="Permalink to this heading"></a></h1>
<p>Follow the installation instructions provided at <a class="reference external" href="http://artery.v2x-research.eu/install/">http://artery.v2x-research.eu/install/</a>.</p>
<p>To integrate ZeroMQ (ZMQ) with Artery and allow it to receive CARLA sensor data, two main steps are required:
(1) enabling ZMQ support in the build system, and (2) developing a custom service that subscribes to the data published by CARLA and uses it inside Artery.</p>
<section id="zeromq-integration">
<h2>ZeroMQ Integration<a class="headerlink" href="#zeromq-integration" title="Permalink to this heading"></a></h2>
<p>First, modify the build configuration so that Artery can locate and link the ZMQ library.</p>
<p>Add the following lines to <code class="docutils literal notranslate"><span class="pre">Path/To/Artery/src/artery/CMakeLists.txt</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Path/To/Artery/src/artery/CMakeLists.txt modifications</span><a class="headerlink" href="#id1" title="Permalink to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">find_package</span><span class="p">(</span><span class="n">PkgConfig</span><span class="w"> </span><span class="n">MODULE</span><span class="w"> </span><span class="n">REQUIRED</span><span class="p">)</span>
<span class="linenos">2</span><span class="n">pkg_check_modules</span><span class="p">(</span><span class="n">ZEROMQ</span><span class="w"> </span><span class="n">REQUIRED</span><span class="w"> </span><span class="n">libzmq</span><span class="p">)</span>
<span class="linenos">3</span><span class="n">target_include_directories</span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">PUBLIC</span><span class="w"> </span><span class="s">&quot;${ZEROMQ_INCLUDES_DIRS}&quot;</span><span class="p">)</span>
<span class="linenos">4</span><span class="n">target_link_libraries</span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">PUBLIC</span><span class="w"> </span><span class="s">&quot;${ZEROMQ_LIBRARIES}&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Once the project builds successfully with ZMQ support, you can implement the service that will receive obstacle information from CARLA.</p>
</section>
<section id="service-development">
<h2>Service Development<a class="headerlink" href="#service-development" title="Permalink to this heading"></a></h2>
<p>To create a new Artery service, follow the procedure described at <a class="reference external" href="http://artery.v2x-research.eu/custom-simulation/">http://artery.v2x-research.eu/custom-simulation/</a>.</p>
<p>In this integration, the implementation builds on the <strong>ExampleService</strong> pattern, but is implemented as <strong>YourService</strong>.
The custom service subscribes to ZMQ messages sent by CARLA, parses the obstacle sensor data, computes the detected obstacle position, and passes the resulting information to other vehicles via Artery messages.</p>
<p>Create the following files in <code class="docutils literal notranslate"><span class="pre">Path/To/Artery/src/artery/application</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">YourService.cc</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">YourService.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">YourService.ned</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">YourServiceMessage.msg</span></code></p></li>
</ul>
<p>Add <code class="docutils literal notranslate"><span class="pre">YourService.cc</span></code> to the corresponding <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file as indicated in the Artery documentation.</p>
<section id="message-definition">
<h3>Message Definition<a class="headerlink" href="#message-definition" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">YourServiceMessage.msg</span></code> file defines the information that will be exchanged between vehicles.</p>
<p>Create <code class="docutils literal notranslate"><span class="pre">YourServiceMessage.msg</span></code> in <code class="docutils literal notranslate"><span class="pre">Path/To/Artery/src/artery/application/</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">YourServiceMessage.msg</span><a class="headerlink" href="#id2" title="Permalink to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">packet</span><span class="w"> </span><span class="n">YourService</span>
<span class="linenos"> 2</span><span class="p">{</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="n">string</span><span class="w"> </span><span class="n">messageType</span><span class="p">;</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">vehicleId</span><span class="p">;</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">sensorId</span><span class="p">;</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">initialTimestamp</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">distance</span><span class="p">;</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="linenos">10</span><span class="p">};</span>
</pre></div>
</div>
</div>
<p>Add the following line in <code class="docutils literal notranslate"><span class="pre">Path/To/Artery/src/artery/CMakeLists.txt</span></code>, after the <code class="docutils literal notranslate"><span class="pre">add_library</span></code> section:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Register YourServiceMessage.msg in core target</span><a class="headerlink" href="#id3" title="Permalink to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="n">generate_opp_message</span><span class="p">(</span><span class="n">application</span><span class="o">/</span><span class="n">YourServiceMessage</span><span class="p">.</span><span class="n">msg</span><span class="w"> </span><span class="n">TARGET</span><span class="w"> </span><span class="n">core</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This line instructs OMNeT++ to generate the C++ message classes used by this service.</p>
</section>
<section id="ned-service-declaration">
<h3>NED Service Declaration<a class="headerlink" href="#ned-service-declaration" title="Permalink to this heading"></a></h3>
<p>A minimal NED definition for the service is:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">YourService.ned</span><a class="headerlink" href="#id4" title="Permalink to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">package</span><span class="w"> </span><span class="n">artery</span><span class="p">.</span><span class="n">application</span><span class="p">;</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="n">simple</span><span class="w"> </span><span class="n">YourService</span><span class="w"> </span><span class="n">like</span><span class="w"> </span><span class="n">ItsG5Service</span>
<span class="linenos">4</span><span class="p">{</span>
<span class="linenos">5</span><span class="w">    </span><span class="nl">parameters</span><span class="p">:</span>
<span class="linenos">6</span><span class="w">        </span><span class="n">string</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">(</span><span class="o">&lt;</span><span class="n">MACHINE_RUNNING_CARLA_IP</span><span class="o">&gt;</span><span class="p">);</span><span class="w">  </span><span class="c1">// ZMQ host</span>
<span class="linenos">7</span><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">(</span><span class="mi">5555</span><span class="p">);</span><span class="w">                 </span><span class="c1">// ZMQ port</span>
<span class="linenos">8</span><span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="json-support">
<h3>JSON Support<a class="headerlink" href="#json-support" title="Permalink to this heading"></a></h3>
<p>To parse the JSON messages sent from CARLA, download <code class="docutils literal notranslate"><span class="pre">json.hpp</span></code> from:</p>
<p><a class="reference external" href="https://github.com/nlohmann/json/blob/develop/include/nlohmann/json.hpp">https://github.com/nlohmann/json/blob/develop/include/nlohmann/json.hpp</a></p>
<p>Place the file in:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Path/To/Artery/src/artery/application/</span></code></p></li>
</ul>
<p>and include it in the CMake file similarly to how <code class="docutils literal notranslate"><span class="pre">YourService.cc</span></code> is added.</p>
</section>
<section id="include-libraries">
<h3>Include Libraries<a class="headerlink" href="#include-libraries" title="Permalink to this heading"></a></h3>
<p>In <code class="docutils literal notranslate"><span class="pre">YourService.cc</span></code>, include the ZMQ, JSON and <code class="docutils literal notranslate"><span class="pre">YourServiceMessage_m.h</span></code> headers, as well as the vehicle controller:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">Include libraries</span><a class="headerlink" href="#id5" title="Permalink to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zmq.hpp&gt;</span>
<span class="linenos">2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;artery/application/json.hpp&quot;</span>
<span class="linenos">3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;artery/application/YourServiceMessage_m.h&quot;</span>
<span class="linenos">4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;artery/traci/VehicleController.h&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="zmq-attributes">
<h3>ZMQ Attributes<a class="headerlink" href="#zmq-attributes" title="Permalink to this heading"></a></h3>
<p>Initialize the self-message pointer as <code class="docutils literal notranslate"><span class="pre">nullptr</span></code> and define the ZMQ socket, context and topic as private attributes of the service class:</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">ZMQ-related attributes in YourService</span><a class="headerlink" href="#id6" title="Permalink to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">namespace</span><span class="w"> </span><span class="nn">artery</span>
<span class="linenos"> 2</span><span class="p">{</span>
<span class="linenos"> 3</span><span class="k">class</span><span class="w"> </span><span class="nc">YourService</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ItsG5Service</span>
<span class="linenos"> 4</span><span class="p">{</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="c1">//[...]</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="k">private</span><span class="o">:</span>
<span class="linenos"> 7</span><span class="w">        </span><span class="c1">//[...]</span>
<span class="linenos"> 8</span><span class="w">         </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">topic</span><span class="p">;</span>
<span class="linenos"> 9</span><span class="w">         </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cMessage</span><span class="o">*</span><span class="w"> </span><span class="n">m_self_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="linenos">10</span><span class="w">         </span><span class="n">zmq</span><span class="o">::</span><span class="n">socket_t</span><span class="w"> </span><span class="n">socket</span><span class="p">;</span>
<span class="linenos">11</span><span class="w">         </span><span class="n">zmq</span><span class="o">::</span><span class="n">context_t</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
<span class="linenos">12</span><span class="p">};</span>
<span class="linenos">13</span><span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="zmq-initialization">
<h3>ZMQ Initialization<a class="headerlink" href="#zmq-initialization" title="Permalink to this heading"></a></h3>
<p>In <code class="xref py py-meth docutils literal notranslate"><span class="pre">YourService.initialize()</span></code>, create and configure the ZMQ subscriber.
It will connect to the TCP endpoint exposed by the CARLA side and subscribe to the configured topic:</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">ZMQ socket initialization in YourService::initialize</span><a class="headerlink" href="#id7" title="Permalink to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kt">void</span><span class="w"> </span><span class="nf">YourService::initialize</span><span class="p">(){</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="c1">//[...]</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zmq</span><span class="o">::</span><span class="n">context_t</span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zmq</span><span class="o">::</span><span class="n">socket_t</span><span class="p">{</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">ZMQ_SUB</span><span class="p">};</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">ZMQ_RCVTIMEO</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w">  </span><span class="c1">// set timeout to 4 seconds</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">ZMQ_SNDTIMEO</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w">  </span><span class="c1">// set timeout to 4 seconds</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">zmq_setsockopt</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">ZMQ_SUBSCRIBE</span><span class="p">,</span><span class="w"> </span><span class="n">topic</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">topic</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">par</span><span class="p">(</span><span class="s">&quot;host&quot;</span><span class="p">).</span><span class="n">stringValue</span><span class="p">();</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">par</span><span class="p">(</span><span class="s">&quot;port&quot;</span><span class="p">).</span><span class="n">intValue</span><span class="p">();</span>
<span class="linenos">10</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tcp://&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="linenos">11</span><span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="linenos">12</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Here:</p>
<ul class="simple">
<li><p>A ZMQ context and SUB socket are created.</p></li>
<li><p>Receive and send timeouts are set (to avoid blocking indefinitely).</p></li>
<li><p>The socket subscribes to the selected topic.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">host</span></code> and <code class="docutils literal notranslate"><span class="pre">port</span></code> parameters from NED are used to build the TCP address where the CARLA publisher is listening.</p></li>
</ul>
</section>
<section id="yourservice-destructor">
<h3>YourService Destructor<a class="headerlink" href="#yourservice-destructor" title="Permalink to this heading"></a></h3>
<p>At the end of the simulation, when the OMNeT++ modules are destroyed, the sockets and self-message must be properly cleaned up.
This is accomplished in the following block:</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">YourService destructor</span><a class="headerlink" href="#id8" title="Permalink to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="n">YourService</span><span class="o">::~</span><span class="n">YourService</span><span class="p">()</span>
<span class="linenos"> 2</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 3</span><span class="w">     </span><span class="n">EV_INFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Closing socket...&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="linenos"> 4</span><span class="w">     </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="linenos"> 5</span><span class="w">     </span><span class="n">EV_INFO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Closing context...&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="linenos"> 6</span><span class="w">     </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="linenos"> 7</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_self_msg</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 8</span><span class="w">         </span><span class="n">cancelAndDelete</span><span class="p">(</span><span class="n">m_self_msg</span><span class="p">);</span>
<span class="linenos"> 9</span><span class="w">         </span><span class="n">m_self_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="linenos">10</span><span class="w">     </span><span class="p">}</span>
<span class="linenos">11</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="receiving-and-using-zmq-data">
<h3>Receiving and Using ZMQ Data<a class="headerlink" href="#receiving-and-using-zmq-data" title="Permalink to this heading"></a></h3>
<p>In <code class="xref py py-meth docutils literal notranslate"><span class="pre">YourService.trigger()</span></code>, before creating and sending the application packet, add the code that:</p>
<ul class="simple">
<li><p>receives messages from the ZMQ socket,</p></li>
<li><p>parses the JSON content,</p></li>
<li><p>computes the world coordinates of the detected obstacle,</p></li>
<li><p>stores the result in a <code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">YourServiceMessage</span></code> instance, and</p></li>
<li><p>sends the resulting message into the Artery communication stack.</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">Handling ZMQ data inside YourService::trigger</span><a class="headerlink" href="#id9" title="Permalink to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="kt">void</span><span class="w"> </span><span class="nf">YourService::trigger</span><span class="p">(){</span>
<span class="linenos">  2</span><span class="w">    </span><span class="c1">//[...]</span>
<span class="linenos">  3</span><span class="w">    </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vehicleController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getFacilities</span><span class="p">().</span><span class="n">get_const</span><span class="o">&lt;</span><span class="n">traci</span><span class="o">::</span><span class="n">VehicleController</span><span class="o">&gt;</span><span class="p">();</span>
<span class="linenos">  4</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">mco</span><span class="p">.</span><span class="n">allChannels</span><span class="p">(</span><span class="n">example_its_aid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  5</span><span class="w">        </span><span class="c1">//[...]</span>
<span class="linenos">  6</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">network</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  7</span><span class="w">            </span><span class="c1">//[...]</span>
<span class="linenos">  8</span><span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">ZMQ_RCVTIMEO</span><span class="p">,</span><span class="w"> </span><span class="mi">400</span><span class="p">);</span>
<span class="linenos">  9</span><span class="w">            </span><span class="n">zmq</span><span class="o">::</span><span class="n">message_t</span><span class="w"> </span><span class="n">reply</span><span class="p">{};</span>
<span class="linenos"> 10</span><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">sndhwm</span><span class="p">;</span>
<span class="linenos"> 11</span><span class="w">            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">sndhwm_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sndhwm</span><span class="p">);</span>
<span class="linenos"> 12</span><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">rc</span><span class="p">;</span>
<span class="linenos"> 13</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">uk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;null&quot;</span><span class="p">;</span>
<span class="linenos"> 14</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sensors_with_input</span><span class="p">;</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 17</span><span class="w">                </span><span class="n">socket</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span><span class="w"> </span><span class="n">zmq</span><span class="o">::</span><span class="n">recv_flags</span><span class="o">::</span><span class="n">dontwait</span><span class="p">);</span>
<span class="linenos"> 18</span><span class="w">                </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zmq_getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">ZMQ_RCVMORE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sndhwm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sndhwm_size</span><span class="p">);</span>
<span class="linenos"> 19</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span>
<span class="linenos"> 20</span><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 21</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="n">to_string</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;{&#39;</span><span class="p">){</span>
<span class="linenos"> 22</span><span class="w">                    </span><span class="n">json</span><span class="w"> </span><span class="n">jsonResp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">json</span><span class="o">::</span><span class="n">parse</span><span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="n">to_string</span><span class="p">());</span>
<span class="linenos"> 23</span><span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">message_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jsonResp</span><span class="p">[</span><span class="s">&quot;message_type&quot;</span><span class="p">].</span><span class="n">get</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">();</span>
<span class="linenos"> 24</span><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">vehicle_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jsonResp</span><span class="p">[</span><span class="s">&quot;vehicle_id&quot;</span><span class="p">].</span><span class="n">get</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">();</span>
<span class="linenos"> 25</span><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">sensor_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jsonResp</span><span class="p">[</span><span class="s">&quot;sensor_id&quot;</span><span class="p">].</span><span class="n">get</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">();</span>
<span class="linenos"> 26</span><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jsonResp</span><span class="p">[</span><span class="s">&quot;timestamp&quot;</span><span class="p">].</span><span class="n">get</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">();</span>
<span class="linenos"> 27</span><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jsonResp</span><span class="p">[</span><span class="s">&quot;distance&quot;</span><span class="p">].</span><span class="n">get</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">();</span>
<span class="linenos"> 28</span>
<span class="linenos"> 29</span><span class="w">                    </span><span class="n">EV</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    OBST-&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sensor_id</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;&lt;&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;@&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vehicle_id</span>
<span class="linenos"> 30</span><span class="w">                    </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; (t=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;)  Distance=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;m</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="linenos"> 31</span>
<span class="linenos"> 32</span><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">vehicle_length</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">vehicleController</span><span class="p">.</span><span class="n">getLength</span><span class="p">().</span><span class="n">value</span><span class="p">();</span>
<span class="linenos"> 33</span><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">vehicle_width</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">vehicleController</span><span class="p">.</span><span class="n">getWidth</span><span class="p">().</span><span class="n">value</span><span class="p">();</span><span class="w"> </span><span class="c1">// unused but ok</span>
<span class="linenos"> 34</span><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">vehicle_angle</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">vehicleController</span><span class="p">.</span><span class="n">getHeading</span><span class="p">().</span><span class="n">radian</span><span class="p">();</span>
<span class="linenos"> 35</span>
<span class="linenos"> 36</span><span class="w">                    </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="w"> </span><span class="n">cur_pos_center</span><span class="p">(</span>
<span class="linenos"> 37</span><span class="w">                        </span><span class="n">vehicleController</span><span class="p">.</span><span class="n">getPosition</span><span class="p">().</span><span class="n">x</span><span class="p">.</span><span class="n">value</span><span class="p">(),</span>
<span class="linenos"> 38</span><span class="w">                        </span><span class="n">vehicleController</span><span class="p">.</span><span class="n">getPosition</span><span class="p">().</span><span class="n">y</span><span class="p">.</span><span class="n">value</span><span class="p">());</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distance</span><span class="p">;</span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span><span class="w">                    </span><span class="c1">// detection in vehicle-local coordinates (relative to center)</span>
<span class="linenos"> 43</span><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">det_x_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vehicle_length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">depth</span><span class="p">;</span>
<span class="linenos"> 44</span><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">det_y_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">cosH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">cos</span><span class="p">(</span><span class="n">vehicle_angle</span><span class="p">);</span>
<span class="linenos"> 47</span><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">sinH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">sin</span><span class="p">(</span><span class="n">vehicle_angle</span><span class="p">);</span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">det_dx</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">cosH</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">det_x_v</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sinH</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">det_y_v</span><span class="p">;</span>
<span class="linenos"> 50</span><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">det_dy</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">sinH</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">det_x_v</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cosH</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">det_y_v</span><span class="p">;</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span><span class="w">                    </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="w"> </span><span class="n">detection_coord</span><span class="w"> </span><span class="o">=</span>
<span class="linenos"> 53</span><span class="w">                        </span><span class="n">cur_pos_center</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="p">(</span><span class="n">det_dx</span><span class="p">,</span><span class="w"> </span><span class="n">det_dy</span><span class="p">);</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="w">                    </span><span class="c1">// sensor at front center</span>
<span class="linenos"> 56</span><span class="w">                    </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="w"> </span><span class="n">sensor_pos</span><span class="w"> </span><span class="o">=</span>
<span class="linenos"> 57</span><span class="w">                        </span><span class="n">cur_pos_center</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="p">(</span><span class="n">vehicle_length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span><span class="w">                    </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="w"> </span><span class="n">detection_pos</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="linenos"> 60</span><span class="w">                    </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="w"> </span><span class="n">coord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sensor_pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">detection_pos</span><span class="p">;</span>
<span class="linenos"> 61</span>
<span class="linenos"> 62</span><span class="w">                    </span><span class="k">auto</span><span class="o">*</span><span class="w"> </span><span class="n">packet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">YourServiceMessage</span><span class="p">(</span><span class="s">&quot;YourService Packet&quot;</span><span class="p">);</span>
<span class="linenos"> 63</span><span class="w">                    </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setMessageType</span><span class="p">(</span><span class="n">message_type</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 64</span><span class="w">                    </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setVehicleId</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">);</span>
<span class="linenos"> 65</span><span class="w">                    </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setSensorId</span><span class="p">(</span><span class="n">sensor_id</span><span class="p">);</span>
<span class="linenos"> 66</span><span class="w">                    </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setInitialTimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">);</span>
<span class="linenos"> 67</span><span class="w">                    </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setDistance</span><span class="p">(</span><span class="n">distance</span><span class="p">);</span>
<span class="linenos"> 68</span><span class="w">                    </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setX</span><span class="p">(</span><span class="n">coord</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 69</span><span class="w">                    </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setY</span><span class="p">(</span><span class="n">coord</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="linenos"> 70</span><span class="w">                    </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setByteLength</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span><span class="w">                    </span><span class="n">request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">packet</span><span class="p">,</span><span class="w"> </span><span class="n">network</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="linenos"> 73</span><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 74</span><span class="w">                    </span><span class="n">EV</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;STRING=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">reply</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="linenos"> 75</span><span class="w">                    </span><span class="n">EV</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;RCV_MORE=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sndhwm</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="linenos"> 76</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 77</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">vehicle_length</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">vehicleController</span><span class="o">-&gt;</span><span class="n">getLength</span><span class="p">().</span><span class="n">value</span><span class="p">();</span>
<span class="linenos"> 80</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">vehicle_width</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">vehicleController</span><span class="o">-&gt;</span><span class="n">getWidth</span><span class="p">().</span><span class="n">value</span><span class="p">();</span>
<span class="linenos"> 81</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">vehicle_angle</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">mVehicleController</span><span class="o">-&gt;</span><span class="n">getHeading</span><span class="p">().</span><span class="n">radian</span><span class="p">();</span><span class="w">   </span><span class="c1">// yaw [rad]</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span><span class="w">            </span><span class="c1">// World position of vehicle center (use whatever Artery gives you here)</span>
<span class="linenos"> 84</span><span class="w">            </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="w"> </span><span class="n">cur_pos_center</span><span class="p">(</span>
<span class="linenos"> 85</span><span class="w">                </span><span class="n">mVehicleController</span><span class="o">-&gt;</span><span class="n">getPosition</span><span class="p">().</span><span class="n">x</span><span class="p">.</span><span class="n">value</span><span class="p">(),</span>
<span class="linenos"> 86</span><span class="w">                </span><span class="n">mVehicleController</span><span class="o">-&gt;</span><span class="n">getPosition</span><span class="p">().</span><span class="n">y</span><span class="p">.</span><span class="n">value</span><span class="p">());</span>
<span class="linenos"> 87</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distance</span><span class="p">;</span><span class="w">  </span><span class="c1">// from your JSON</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="w">            </span><span class="c1">// Detection in vehicle-local coordinates (relative to center)</span>
<span class="linenos"> 90</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">det_x_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vehicle_length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">depth</span><span class="p">;</span><span class="w">  </span><span class="c1">// forward</span>
<span class="linenos"> 91</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">det_y_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w">                           </span><span class="c1">// centered</span>
<span class="linenos"> 92</span>
<span class="linenos"> 93</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">cosH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">cos</span><span class="p">(</span><span class="n">vehicle_angle</span><span class="p">);</span>
<span class="linenos"> 94</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">sinH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">sin</span><span class="p">(</span><span class="n">vehicle_angle</span><span class="p">);</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="w">            </span><span class="c1">// Rotate from vehicle frame to world frame</span>
<span class="linenos"> 97</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">det_dx</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">cosH</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">det_x_v</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sinH</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">det_y_v</span><span class="p">;</span>
<span class="linenos"> 98</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">det_dy</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">sinH</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">det_x_v</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cosH</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">det_y_v</span><span class="p">;</span>
<span class="linenos"> 99</span>
<span class="linenos">100</span><span class="w">            </span><span class="c1">// Final world coordinates of the detection (method 1)</span>
<span class="linenos">101</span><span class="w">            </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="w"> </span><span class="n">detection_coord</span><span class="w"> </span><span class="o">=</span>
<span class="linenos">102</span><span class="w">                </span><span class="n">cur_pos_center</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="p">(</span><span class="n">det_dx</span><span class="p">,</span><span class="w"> </span><span class="n">det_dy</span><span class="p">);</span>
<span class="linenos">103</span>
<span class="linenos">104</span><span class="w">            </span><span class="n">vehicle_angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mVehicleController</span><span class="o">-&gt;</span><span class="n">getHeading</span><span class="p">().</span><span class="n">radian</span><span class="p">();</span>
<span class="linenos">105</span><span class="w">            </span><span class="c1">// Sensor at front center</span>
<span class="linenos">106</span><span class="w">            </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="w"> </span><span class="n">sensor_pos</span><span class="w"> </span><span class="o">=</span>
<span class="linenos">107</span><span class="w">                </span><span class="n">cur_pos_center</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="p">(</span><span class="n">vehicle_length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="linenos">108</span>
<span class="linenos">109</span><span class="w">            </span><span class="c1">// Detection depth straight ahead of the sensor</span>
<span class="linenos">110</span><span class="w">            </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="w"> </span><span class="n">detection_pos</span><span class="w"> </span><span class="o">=</span>
<span class="linenos">111</span><span class="w">                </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="linenos">112</span>
<span class="linenos">113</span><span class="w">            </span><span class="c1">// World coordinate of detection (method 2)</span>
<span class="linenos">114</span><span class="w">            </span><span class="n">omnetpp</span><span class="o">::</span><span class="n">cFigure</span><span class="o">::</span><span class="n">Point</span><span class="w"> </span><span class="n">coord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sensor_pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">detection_pos</span><span class="p">;</span>
<span class="linenos">115</span>
<span class="linenos">116</span><span class="w">            </span><span class="n">YourServiceMessage</span><span class="o">*</span><span class="w"> </span><span class="n">packet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">YourServiceMessage</span><span class="p">(</span><span class="s">&quot;YourService Packet&quot;</span><span class="p">);</span>
<span class="linenos">117</span><span class="w">            </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setMessageType</span><span class="p">(</span><span class="n">message_type</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos">118</span><span class="w">            </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setVehicleId</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos">119</span><span class="w">            </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setSensorId</span><span class="p">(</span><span class="n">sensor_id</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos">120</span><span class="w">            </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setInitialTimestamp</span><span class="p">(</span><span class="n">initial_timestamp</span><span class="p">);</span>
<span class="linenos">121</span><span class="w">            </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setDistance</span><span class="p">(</span><span class="n">distance</span><span class="p">);</span>
<span class="linenos">122</span><span class="w">            </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setX</span><span class="p">(</span><span class="n">coord</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">123</span><span class="w">            </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setY</span><span class="p">(</span><span class="n">coord</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">124</span><span class="w">            </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">setByteLength</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span><span class="w">  </span><span class="c1">// optional, for simulation traffic size</span>
<span class="linenos">125</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">126</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">127</span><span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="explanation-of-the-last-block">
<h3>Explanation of the Last Block<a class="headerlink" href="#explanation-of-the-last-block" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><dl class="simple">
<dt>The inner <code class="docutils literal notranslate"><span class="pre">do</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span> <span class="pre">while</span> <span class="pre">(true);</span></code> loop:</dt><dd><ul>
<li><p>Uses <code class="docutils literal notranslate"><span class="pre">socket.recv(...,</span> <span class="pre">zmq::recv_flags::dontwait)</span></code> to read all available ZMQ messages without blocking.</p></li>
<li><dl class="simple">
<dt>For each message, it parses the JSON payload and extracts:</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">message_type</span></code> - type of message (e.g., obstacle data),</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vehicle_id</span></code> - identifier of the vehicle in SUMO/CARLA,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sensor_id</span></code> - identifier of the sensor on that vehicle,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">initial_timestamp</span></code> - timestamp from CARLA,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">distance</span></code> - obstacle distance reported by the sensor.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>It prints a debug line with the obstacle ID, vehicle, timestamp, and distance.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>After consuming all pending messages, the code retrieves the vehicle geometry and pose:</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">vehicle_length</span></code> and <code class="docutils literal notranslate"><span class="pre">vehicle_width</span></code> from the Artery vehicle model,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vehicle_angle</span></code> from <code class="docutils literal notranslate"><span class="pre">getHeading().radian()</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cur_pos_center</span></code> as the world coordinate of the vehicle center.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>The variable <code class="docutils literal notranslate"><span class="pre">depth</span></code> is set to the reported <code class="docutils literal notranslate"><span class="pre">distance</span></code> and is interpreted as the distance of the obstacle in front of the vehicle along its longitudinal axis.</p></li>
<li><dl class="simple">
<dt>The detection is first expressed in <strong>vehicle-local coordinates</strong>:</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">det_x_v</span></code> is half the vehicle length plus the obstacle depth (distance ahead of the center),</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">det_y_v</span></code> is zero, meaning the detection lies on the vehicle’s longitudinal axis.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>The pair <code class="docutils literal notranslate"><span class="pre">(det_x_v,</span> <span class="pre">det_y_v)</span></code> is then rotated into <strong>world coordinates</strong> using the vehicle heading:</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">det_dx</span></code> and <code class="docutils literal notranslate"><span class="pre">det_dy</span></code> give the obstacle’s offset relative to the vehicle center in the global coordinate system.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Two equivalent methods are shown:</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">detection_coord</span></code> adds the rotated offset directly to <code class="docutils literal notranslate"><span class="pre">cur_pos_center</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">coord</span></code> first defines a sensor located at the front of the vehicle, then adds a straight-ahead offset (<code class="docutils literal notranslate"><span class="pre">depth</span></code>) to locate the detection point.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Finally, a <code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">YourServiceMessage</span></code> is created and filled:</dt><dd><ul>
<li><p>The message fields are populated with the parsed JSON values.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">distance</span></code> is stored as received.</p></li>
<li><p>The world coordinates of the detection are stored in <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> using <code class="docutils literal notranslate"><span class="pre">coord</span></code>.</p></li>
<li><p>The optional byte length field is set to 42 to simulate network payload size.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>This packet can then be forwarded by the service to other vehicles, which can process the obstacle information using Artery’s normal message-handling mechanisms.</p>
</section>
</section>
<section id="scenario-development">
<h2>Scenario Development<a class="headerlink" href="#scenario-development" title="Permalink to this heading"></a></h2>
<p>After compiling the custom service successfully, the next step is to create and configure the simulation scenario in which it will run.
Follow the detailed setup guide at <a class="reference external" href="http://artery.v2x-research.eu/custom-simulation/">http://artery.v2x-research.eu/custom-simulation/</a> as a reference for the standard Artery workflow.</p>
<p>For this framework, the scenario directory will be located at:</p>
<p><code class="docutils literal notranslate"><span class="pre">Path/To/Artery/scenarios/framework</span></code></p>
<section id="obtaining-sumo-files">
<h3>Obtaining SUMO Files<a class="headerlink" href="#obtaining-sumo-files" title="Permalink to this heading"></a></h3>
<p>To ensure compatibility between CARLA and Artery, you need the corresponding SUMO configuration files.
CARLA already provides ready-to-use SUMO projects for several towns in:</p>
<p><code class="docutils literal notranslate"><span class="pre">Path/To/CARLA/Co-Simulation/Sumo/examples</span></code></p>
<p>The default examples include <strong>Town01</strong>, <strong>Town05</strong>, and <strong>Town06</strong>.
If you wish to work with another CARLA map, CARLA provides a utility to automatically generate the SUMO network files.
Refer to: <a class="reference external" href="https://carla.readthedocs.io/en/latest/adv_sumo/#create-the-sumo-net">https://carla.readthedocs.io/en/latest/adv_sumo/#create-the-sumo-net</a> for the required steps.</p>
<p>Furthermore, SUMO needs to know which vehicles it is importing from CARLA.
Follow the steps in <a class="reference external" href="https://carla.readthedocs.io/en/latest/adv_sumo/#create-carla-vtypes">https://carla.readthedocs.io/en/latest/adv_sumo/#create-carla-vtypes</a> to define CARLA vtypes for SUMO.</p>
<p>For demonstration purposes, the provided examples will suffice.
Copy the folder <code class="docutils literal notranslate"><span class="pre">examples</span></code> from <code class="docutils literal notranslate"><span class="pre">Path/To/CARLA/Co-Simulation/Sumo/</span></code> and paste it into your new directory:</p>
<p><code class="docutils literal notranslate"><span class="pre">Path/To/Artery/scenarios/framework</span></code></p>
</section>
<section id="scenario-configuration">
<h3>Scenario Configuration<a class="headerlink" href="#scenario-configuration" title="Permalink to this heading"></a></h3>
<p>Next, create an <code class="docutils literal notranslate"><span class="pre">omnetpp.ini</span></code> file inside the scenario directory.
This configuration defines how Artery and SUMO will launch and synchronize during the simulation:</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">omnetpp.ini</span><a class="headerlink" href="#id10" title="Permalink to this code"></a></div>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">[General]</span>
<span class="linenos">2</span><span class="na">network</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">artery.inet.World</span><span class="w"> </span><span class="c1"># Avoid Veins</span>
<span class="linenos">3</span><span class="na">*.traci.launcher.typename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;PosixLauncher&quot;</span><span class="w"> </span><span class="c1"># Launch SUMO</span>
<span class="linenos">4</span><span class="na">*.traci.launcher.port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">9998</span><span class="w"> </span><span class="c1"># SUMO port</span>
<span class="linenos">5</span><span class="na">*.traci.launcher.extraOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;--num-clients 2&quot;</span><span class="w"> </span><span class="c1"># 2 clients: run_synchronization.py and Artery</span>
<span class="linenos">6</span><span class="na">*.traci.launcher.sumocfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;examples/Town05.sumocfg&quot;</span><span class="w"> </span><span class="c1"># SUMO files</span>
<span class="linenos">7</span><span class="na">*.node[*].middleware.updateInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0.05s</span><span class="w"> </span><span class="c1"># Match CARLA tick rate</span>
<span class="linenos">8</span><span class="na">*.node[*].middleware.datetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;2025-11-06 13:30:00&quot;</span><span class="w"> </span><span class="c1"># Start date and time</span>
<span class="linenos">9</span><span class="na">*.node[*].middleware.services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">xmldoc(&quot;services.xml&quot;)</span><span class="w"> </span><span class="c1"># XML file listing YourService</span>
</pre></div>
</div>
</div>
</section>
<section id="defining-services">
<h3>Defining Services<a class="headerlink" href="#defining-services" title="Permalink to this heading"></a></h3>
<p>The XML file listed above defines which services will be active in this scenario.
Place it in the same directory as <code class="docutils literal notranslate"><span class="pre">omnetpp.ini</span></code> and name it <code class="docutils literal notranslate"><span class="pre">services.xml</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">services.xml</span><a class="headerlink" href="#id11" title="Permalink to this code"></a></div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="linenos">2</span><span class="nt">&lt;services&gt;</span>
<span class="linenos">3</span><span class="w">    </span><span class="nt">&lt;service</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;artery.application.YourService&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;YS&quot;</span><span class="nt">&gt;</span>
<span class="linenos">4</span><span class="w">        </span><span class="nt">&lt;listener</span><span class="w"> </span><span class="na">port=</span><span class="s">&quot;2024&quot;</span><span class="nt">/&gt;</span>
<span class="linenos">5</span><span class="w">    </span><span class="nt">&lt;/service&gt;</span>
<span class="linenos">6</span><span class="nt">&lt;/services&gt;</span>
</pre></div>
</div>
</div>
</section>
<section id="vehicle-population">
<h3>Vehicle Population<a class="headerlink" href="#vehicle-population" title="Permalink to this heading"></a></h3>
<p>CARLA also provides route definition files that populate each town with traffic participants.
For Town05, the file is located at:</p>
<p><code class="docutils literal notranslate"><span class="pre">examples/rou/Town05.rou.xml</span></code></p>
<p>By default, this file defines around 200 vehicles.
To simplify testing and ensure correct behavior during initial validation, reduce the number of vehicles to two.
Your modified <code class="docutils literal notranslate"><span class="pre">Town05.rou.xml</span></code> should look like this:</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">rou.xml</span><a class="headerlink" href="#id12" title="Permalink to this code"></a></div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">&lt;?xml version=&#39;1.0&#39; encoding=&#39;UTF-8&#39;?&gt;</span>
<span class="linenos"> 2</span><span class="nt">&lt;routes</span><span class="w"> </span><span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<span class="linenos"> 3</span><span class="w">        </span><span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">&quot;http://sumo.dlr.de/xsd/routes_file.xsd&quot;</span><span class="nt">&gt;</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="nt">&lt;vehicle</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;vehicle.bh.crossbike&quot;</span><span class="w"> </span><span class="na">depart=</span><span class="s">&quot;0.00&quot;</span><span class="nt">&gt;</span>
<span class="linenos"> 5</span><span class="w">        </span><span class="nt">&lt;route</span><span class="w"> </span><span class="na">edges=</span><span class="s">&quot;43.0.00 23.0.00 -52.0.00 49.0.00 7.0.00 6.0.00&quot;</span><span class="nt">/&gt;</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="nt">&lt;/vehicle&gt;</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="nt">&lt;vehicle</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;vehicle.micro.microlino&quot;</span><span class="w"> </span><span class="na">depart=</span><span class="s">&quot;1.00&quot;</span><span class="nt">&gt;</span>
<span class="linenos"> 8</span><span class="w">        </span><span class="nt">&lt;route</span><span class="w"> </span><span class="na">edges=</span><span class="s">&quot;33.0.00 -39.0.00 25.0.00 -6.0.00&quot;</span><span class="nt">/&gt;</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="nt">&lt;/vehicle&gt;</span>
<span class="linenos">10</span><span class="nt">&lt;/routes&gt;</span>
</pre></div>
</div>
</div>
<p>For more details on SUMO route configuration, visit:
<a class="reference external" href="https://sumo.dlr.de/docs/Definition_of_Vehicles%2C_Vehicle_Types%2C_and_Routes.html">https://sumo.dlr.de/docs/Definition_of_Vehicles%2C_Vehicle_Types%2C_and_Routes.html</a></p>
</section>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this heading"></a></h2>
<p>In this section, you:</p>
<ul class="simple">
<li><p>Enabled ZeroMQ support in the Artery build system.</p></li>
<li><p>Created a custom Artery service (YourService) to subscribe to CARLA sensor data.</p></li>
<li><p>Defined the <code class="file docutils literal notranslate"><span class="pre">YourServiceMessage.msg</span></code> message format and integrated it into the build.</p></li>
<li><p>Implemented ZMQ initialization, subscription, cleanup, and a destructor for safe shutdown.</p></li>
<li><p>Parsed JSON messages from CARLA and computed obstacle positions in world coordinates.</p></li>
<li><p>Created a scenario directory, INI configuration, services XML, and a simplified SUMO route file.</p></li>
</ul>
<p>With these steps, Artery is now ready to receive and process obstacle data from CARLA, completing the network-simulation side of the framework.</p>
<p>This setup can also be easily adapted to the widely used VANET simulator Vehicles in Network Simulation (VEINS).</p>
<section id="continue">
<h3>Continue<a class="headerlink" href="#continue" title="Permalink to this heading"></a></h3>
<p>You can now proceed to running the full co-simulation:</p>
<ul class="simple">
<li><p><a class="reference internal" href="run_simulation.html"><span class="doc">Run Simulation</span></a> - how to launch CARLA, SUMO, and Artery together.</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="carla_sumo_cosim.html" class="btn btn-neutral float-left" title="CARLA and SUMO Setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="run_simulation.html" class="btn btn-neutral float-right" title="Run Simulation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Filipe Peixoto, Marcelo Alves.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
